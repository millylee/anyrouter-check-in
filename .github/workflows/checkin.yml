name: "ğŸš€ AnyRouter/AgentRouter è‡ªåŠ¨ç­¾åˆ°"

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 (UTC 1:00) å’Œ 10:00 (UTC 2:00)
  schedule:
    - cron: '0 1 * * *'  # UTC 1:00 = åŒ—äº¬æ—¶é—´ 9:00
    - cron: '0 2 * * *'  # UTC 2:00 = åŒ—äº¬æ—¶é—´ 10:00
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      run_now:
        description: 'ç«‹å³è¿è¡Œç­¾åˆ°'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# åªè¿è¡Œä¸€ä¸ªå®ä¾‹ï¼Œé¿å…é‡å¤æ‰§è¡Œ
concurrency:
  group: anyrouter-checkin
  cancel-in-progress: false

jobs:
  checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # é˜²æ­¢è¶…æ—¶æµªè´¹ç§¯åˆ†

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. è®¾ç½® Python
      - name: ğŸ”§ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: âš™ï¸ å®‰è£… Python ä¾èµ–
        run: |
          pip install httpx playwright python-dotenv
          echo "âœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # 4. ç¼“å­˜ Playwright æµè§ˆå™¨
      - name: ğŸ—‚ï¸ ç¼“å­˜ Playwright æµè§ˆå™¨
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # 5. å®‰è£… Playwright æµè§ˆå™¨ï¼ˆå¦‚æœªç¼“å­˜ï¼‰
      - name: ğŸŒ å®‰è£… Playwright Chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          playwright install chromium
          echo "âœ… æµè§ˆå™¨å®‰è£…å®Œæˆ"

      # 6. æ¢å¤ä½™é¢å†å²è®°å½•ï¼ˆç”¨äºæ£€æµ‹å˜åŒ–ï¼‰
      - name: ğŸ“Š æ¢å¤ä½™é¢å†å²ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: balance_hash.txt
          key: balance-hash-${{ github.ref_name }}
          restore-keys: |
            balance-hash-${{ github.ref_name }}
            balance-hash-main

      # 7. æ‰§è¡Œç­¾åˆ°ä»»åŠ¡
      - name: ğŸš€ æ‰§è¡Œç­¾åˆ°
        id: checkin
        env:
          # æ ¸å¿ƒé…ç½® - ä½¿ç”¨ GitHub Secrets
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}

          # é€šçŸ¥é…ç½®ï¼ˆå¯é€‰ï¼‰
          EMAIL_ENABLED: ${{ secrets.EMAIL_ENABLED }}
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}

          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          WECHAT_WORK_KEY: ${{ secrets.WECHAT_WORK_KEY }}
          GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ” æ£€æŸ¥é…ç½®..."
          if [ -z "${{ secrets.ANYROUTER_ACCOUNTS }}" ]; then
            echo "âŒ é”™è¯¯: æœªè®¾ç½® ANYROUTER_ACCOUNTS secrets"
            echo "è¯·åœ¨ä»“åº“ Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ "
            exit 1
          fi

          echo "âœ… é…ç½®å­˜åœ¨ï¼Œå¼€å§‹æ‰§è¡Œç­¾åˆ°..."
          python checkin.py

          # ä¿å­˜é€€å‡ºç 
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      # 8. ä¿å­˜ä½™é¢å†å²ï¼ˆç”¨äºä¸‹æ¬¡æ¯”è¾ƒï¼‰
      - name: ğŸ’¾ ä¿å­˜ä½™é¢å†å²
        if: always()
        uses: actions/cache@v4
        with:
          path: balance_hash.txt
          key: balance-hash-${{ github.ref_name }}-${{ github.run_number }}
          restore-keys: |
            balance-hash-${{ github.ref_name }}

      # 9. å‘é€æ‰§è¡Œç»“æœé€šçŸ¥ï¼ˆä»…åœ¨å¤±è´¥æ—¶ï¼Œé¿å…è¿‡åº¦é€šçŸ¥ï¼‰
      - name: ğŸ“¬ å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const webhookUrl = process.env.DINGTALK_WEBHOOK;
            if (!webhookUrl) return;

            const payload = {
              msgtype: "markdown",
              markdown: {
                title: "AnyRouter ç­¾åˆ°å¤±è´¥",
                text: `## âŒ AnyRouter ç­¾åˆ°å¤±è´¥\n\n**ä»“åº“**: ${context.repo.repo}\n**æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n**å·¥ä½œæµ**: ${context.workflow}\n\nè¯·æ£€æŸ¥æ—¥å¿—æˆ–é…ç½®ã€‚`
              }
            };

            await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

      # 10. æ€»ç»“è¾“å‡º
      - name: ğŸ“‹ æ‰§è¡Œæ€»ç»“
        if: always()
        run: |
          echo "========== æ‰§è¡Œæ€»ç»“ =========="
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "çŠ¶æ€: ${{ needs.checkin.result || 'COMPLETED' }}"
          echo "è§¦å‘: ${{ github.event_name }}"
          echo "=============================="

          # æ˜¾ç¤ºä½™é¢å†å²æ–‡ä»¶ä¿¡æ¯
          if [ -f balance_hash.txt ]; then
            echo "ä½™é¢å†å²æ–‡ä»¶å¤§å°: $(wc -c < balance_hash.txt) bytes"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä½™é¢å†å²æ–‡ä»¶"
          fi